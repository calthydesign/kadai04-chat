<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã­ã“å ã„ã¤ããƒãƒ£ãƒƒãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-size: 1rem;
      }
      p {
        text-align: center;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
      }
      img {
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body class="relative">
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
    <header>
      <h1 class=""><img src="./img/logo.png" alt="logo" /></h1>
    </header>
    <div
      class="flex align-center justify-center items-center bg-white z-50 fixed h-24 bottom-0 w-full magin-auto"
    >
      <div>NAMEï¼š<input type="text" id="uname" class="bg-slate-50 mr-8" /></div>
      <div class="flex">
        <textarea
          id="text"
          cols="50"
          rows="1"
          class="bg-slate-50 mr-8 md:mt-2 sm:mt-2"
          placeholder="message"
        ></textarea>
        <br />
        <button id="send">
          <img
            src="./img/send.png"
            alt="send"
            class="bg-green-500 w-12 h-12 p-2 rounded-lg"
          />
        </button>
      </div>
    </div>
    <div>
      <span id="uranai"></span>
      <div
        id="output"
        style="overflow: auto"
        class="flex-col justify-center"
      ></div>
    </div>

    <!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- ä»¥ä¸‹Firebase -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        update,
        onChildAdded,
        onChildChanged,
        remove,
        onChildRemoved,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      const firebaseConfig = {
        //firebaseã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ•°
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig); //ã“ã®ã‚­ãƒ¼ã‚’æŒã£ã¦initializeAppã‚’å®Ÿè¡Œã™ã‚‹
      const db = getDatabase(app); //RealtimeDatabaseã«æ¥ç¶š  getDatabaseã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å–å¾—
      const dbRef = ref(db, "chat"); //ã©ã“ã®éšå±¤ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‹ã¨ã„ã†ã“ã¨  RealtimeDBã®"chat"ã‚’ã¤ã‹ã†

      //æŠ•ç¨¿æ™‚é–“ã®å–å¾—,Bingã«èã„ãŸ
      function getCurrentTime() {
        // ã“ã“ã§ç¾åœ¨ã®æ™‚é–“ã‚’å–å¾—ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…
        let now = new Date();
        const nowMon = now.getMonth() + 1;
        const nowDate = now.getDate();
        const nowHour = now.getHours();
        const nowMinute = now.getMinutes();

        return `${nowMon}/${nowDate} ${nowHour}:${nowMinute}`;
      }

      //é€ä¿¡
      $("#send").on("click", function () {
        const msg = {
          uname: $("#uname").val(),
          text: $("#text").val(),
          //ã“ã“ã«å–å¾—ã—ãŸæ™‚é–“ã‚’è¿½åŠ ã—ã¦firebaseã«ã‚‚ä¿å­˜ã™ã‚‹
          time: getCurrentTime(), // Bingã«èã„ã¦ã¿ãŸ
          uranai: uranai(),
        };
        const newPostRef = push(dbRef); //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹ã€‚"chat"ã«å…¥ã£ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹dbRefã¨ã„ã†å¤‰æ•°ã‚’push(å…¥ã‚Œã‚‹)
        set(newPostRef, msg); //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸¡æ–¹ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
      });

      onChildAdded(dbRef, function (data) {
        const msg = data.val(); //dataã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ãã‚‹Firebaseã®é–¢æ•°
        const key = data.key; //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼
        //è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ»HTMLã‚’ä½œæˆ
        let h = '<p id="' + key + '">';
        h += msg.uranai;
        h += msg.uname;
        h += "<br>";
        h +=
          '<span contentEditable = "true" id="' +
          key +
          '_update">' +
          msg.text +
          "</span>";
        h += "<br>";
        h += msg.time;
        h += '<span class="remove" data-key"' + key + '">ğŸš®</span>';
        h += '<span class="update" data-key"' + key + '">ğŸ†™</span>';
        h += "</p>";
        $("#output").prepend(h);
      });

      //å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
      $("#output").on("click", ".remove", function () {
        //removeã®ã‚¯ãƒ©ã‚¹ã‚’ç›£è¦–ã•ã›ãŸã„
        const key = $(this).attr("data-key"); //attrã¯attributeã€‚thisã¯æŠ¼ã—ãŸå ´æ‰€ã ã‘è¦‹ã‚‹ã‚ˆã†ã«ãªã‚‹
        const remove_item = ref(db, "chat/" + key); //refã¨ã„ã†é–¢æ•°
        remove(remove_item); //Firebaseãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–¢æ•°
      });
      //æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
      $("#output").on("click", ".update", function () {
        const key = $(this).attr("data-key");
        update(ref(db, "chat/" + key)),
          {
            text: $("#" + key + "_update").html(),
          };
      });

      //å‰Šé™¤å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
      onChildRemoved(dbRef, (data) => {
        $("#", +data.key).remove(); //DOMæ“ä½œé–¢æ•°ï¼ˆå¯¾è±¡ã‚’å‰Šé™¤ï¼‰
      });

      //æ›´æ–°å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
      onChildChanged(dbRef, (data) => {
        $("#" + data.key + "_update").html(data.val().text);
        $("#" + data.key + "_update")
          .fadeOut(800)
          .fadeIn(800);
      });

      //å ã„
      function uranai() {
        //ãƒ©ãƒ³ãƒ€ãƒ é–¢æ•°
        const r = Math.ceil(Math.random() * 5);
        //æ¡ä»¶åˆ†å²
        let view = "";
        if (r === 1) {
          view = '<img src="./img/excellentluck.png" alt="å¤§å‰">';
        } else if (r === 2) {
          view = '<img src="./img/goodluck.png" alt="ä¸­å‰">';
        } else if (r === 3) {
          view = '<img src="./img/goodluck.png" alt="å°å‰">';
        } else if (r === 4) {
          view = '<img src="./img/slightlygoodluck.png" alt="å‰">';
        } else if (r === 5) {
          view = '<img src="./img/badluck.png" alt="å‡¶">';
        }
        return `${view}`;
      }
    </script>
  </body>
</html>
